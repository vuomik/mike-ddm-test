#!/bin/bash
set -e

GITHUB_USERNAME="vuomik"
GITHUB_REPO="mike-ddm-test"
IMAGE_NAME="mike-ddm-app-prod"
IMAGE_TAG="latest"
FLY_APP_NAME="mike-ddm-app"
GHCR_REGISTRY="ghcr.io"
if [ -z "$GITHUB_TOKEN" ]; then
  echo "ERROR: Please set your GitHub Personal Access Token in the GITHUB_TOKEN environment variable."
  exit 1
fi
if [ -z "$GOODREADS_KEY" ]; then
  echo "ERROR: Please set your Goodreads key in the GOODREADS_KEY environment variable."
  exit 1
fi

if ! command -v flyctl &> /dev/null; then
  echo "flyctl not found, installing..."
  curl -s -L https://fly.io/install.sh | sh
  export PATH="$HOME/.fly/bin:$PATH"
  echo "flyctl installed successfully."
fi

# Full image name in GHCR
FULL_IMAGE_NAME="$GHCR_REGISTRY/$GITHUB_USERNAME/$IMAGE_NAME:$IMAGE_TAG"

echo "Building Docker image with production stage..."
docker build --target production -t $FULL_IMAGE_NAME .

echo "Logging into GitHub Container Registry..."
echo $GITHUB_TOKEN | docker login $GHCR_REGISTRY -u $GITHUB_USERNAME --password-stdin

echo "Pushing image to GitHub Container Registry..."
docker push $FULL_IMAGE_NAME

echo "Deploying to Fly.io..."
cat > fly.toml <<EOF
app = "$FLY_APP_NAME"

[build]
  image = "$FULL_IMAGE_NAME"

[registry]
  username = "$GITHUB_USERNAME"
  password = "$GITHUB_TOKEN"

[env]
  NODE_ENV = "production"
  PORT = 3000
  GOODREADS_KEY = "$GOODREADS_KEY"

[[services]]
  internal_port = 3000
  protocol = "tcp"

  [[services.ports]]
    port = 80
    handlers = ["http"]

  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

  [[services.tcp_checks]]
    interval = 600000
    timeout = 300000
    grace_period = "30s"
    restart_limit = 0
EOF

cat fly.toml

flyctl deploy --config fly.toml

echo "Deployment complete! Your app should be live at https://$FLY_APP_NAME.fly.dev"
